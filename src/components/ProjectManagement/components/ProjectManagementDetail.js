import React, { useState, useEffect, useCallback } from 'react';
import ProjectInfo from './ProjectManagementDetail/components/ProjectInfo';
import ProjectEditDialog from './ProjectManagementDetail/components/ProjectEditDialog';
import ProjectSelector from './ProjectManagementDetail/components/ProjectSelector';
import MemberManagement from './ProjectManagementDetail/components/MemberManagement';
import ServerManagement from './ProjectManagementDetail/components/ServerManagement';
import ResourceManagement from './ProjectManagementDetail/components/ResourceManagement';
import MemberDialog from './ProjectManagementDetail/components/MemberDialog';
import ServerDialog from './ProjectManagementDetail/components/ServerDialog';
import ResourceDialog from './ProjectManagementDetail/components/ResourceDialog';

import * as api from './ProjectManagementDetail/api/projectDetailsApi';
import { getFilteredMembers, getFilteredServers, getFilteredResources } from './ProjectManagementDetail/utils/filterUtils';

const ProjectManagementDetail = ({ user, selectedProject, isMobile }) => {
  const [activeTab, setActiveTab] = useState('info');
  const [projects, setProjects] = useState([]);
  const [members, setMembers] = useState([]);
  const [servers, setServers] = useState([]);
  const [resources, setResources] = useState([]);
  const [showDialog, setShowDialog] = useState(null);
  const [editForm, setEditForm] = useState({});
  const [editingProjectId, setEditingProjectId] = useState(null);
  const [selectedProjectFilter, setSelectedProjectFilter] = useState(null);
  const [allUsers, setAllUsers] = useState([]);

  // Tab ÂÆö‰πâ
  const tabs = [
    { id: 'info', name: 'È°πÁõÆ‰ø°ÊÅØ', icon: 'üìã' },
    { id: 'members', name: 'È°πÁõÆÊàêÂëò', icon: 'üë•' },
    { id: 'servers', name: 'ÊúçÂä°Âô®‰ø°ÊÅØ', icon: 'üñ•Ô∏è' },
    { id: 'resources', name: 'ËΩØ‰ª∂ËµÑÊñô', icon: 'üì¶' }
  ];

  // ÂàùÂßãÂåñÊï∞ÊçÆ
  useEffect(() => {
    if (selectedProject) {
      loadProjectDetails();
      loadAllUsers();
    }
  }, [selectedProject]);

  // ÂΩì projects Âä†ËΩΩÂÆåÊàêÂêéÔºåËá™Âä®ÈÄâÊã©ÈªòËÆ§È°πÁõÆ
  useEffect(() => {
    if (projects.length > 0 && selectedProjectFilter === null) {
      const defaultProject = projects.find(p => p.isDefault);
      if (defaultProject) {
        setSelectedProjectFilter(defaultProject.id);
      } else {
        setSelectedProjectFilter(projects[0].id);
      }
    }
  }, [projects, selectedProjectFilter]);

  // Âä†ËΩΩÊâÄÊúâÁî®Êà∑ÂàóË°®
  const loadAllUsers = async () => {
    try {
      const users = await api.fetchAllUsers();
      setAllUsers(users);
    } catch (error) {
      console.error('Ëé∑ÂèñÁî®Êà∑ÂàóË°®Â§±Ë¥•:', error);
    }
  };

  // Âä†ËΩΩÈ°πÁõÆËØ¶ÊÉÖ
  const loadProjectDetails = async () => {
    try {
      const [projectsData, membersData, serversData, resourcesData] = await Promise.all([
        api.fetchProjects(),
        api.fetchMembers(),
        api.fetchServers(),
        api.fetchResources()
      ]);

      setProjects(projectsData);
      setMembers(membersData);
      setServers(serversData);
      setResources(resourcesData);
    } catch (error) {
      console.error('Ëé∑ÂèñÈ°πÁõÆËØ¶ÊÉÖÂ§±Ë¥•:', error);
    }
  };

  // ==================== È°πÁõÆÁõ∏ÂÖ≥Êìç‰Ωú ====================
  const handleAddProject = () => {
    setEditForm({
      id: Date.now(),
      name: '',
      description: '',
      status: 'ËßÑÂàí‰∏≠',
      startDate: '',
      endDate: '',
      progress: 0,
      budget: '',
      department: '',
      priority: '‰∏≠',
      type: '',
      customer: '',
      manager: '',
      team: '',
      isDefault: false
    });
    setEditingProjectId(null);
    setShowDialog('editProject');
  };

  const handleEditProject = (project) => {
    setEditingProjectId(project.id);
    setEditForm({ ...project });
    setShowDialog('editProject');
  };

  const handleSaveProject = async () => {
    try {
      // ‰ªéÈ°πÁõÆÁªèÁêÜÈÄâÊã©ÊñáÊú¨‰∏≠ÊèêÂèñÁî®Êà∑‰ø°ÊÅØ
      let managerId = editForm.managerId;
      if (editForm.manager && allUsers.length > 0) {
        const managerText = editForm.manager;
        const matchedUser = allUsers.find(u => 
          managerText.includes(u.full_name || u.username)
        );
        if (matchedUser) {
          managerId = matchedUser.id;
        }
      }

      // ÂáÜÂ§áÊèê‰∫§ÁöÑÊï∞ÊçÆ
      const projectData = {
        name: editForm.name,
        description: editForm.description,
        status: editForm.status,
        priority: editForm.priority,
        type: editForm.type,
        startDate: editForm.startDate,
        endDate: editForm.endDate,
        progress: editForm.progress || 0,
        budget: editForm.budget || 0,
        department: editForm.department,
        team: editForm.team,
        customer: editForm.customer,
        clientId: editForm.clientId,
        managerId: managerId,
        isDefault: editForm.isDefault || false
      };

      await api.saveProject(projectData, editingProjectId);

      alert(`‚úÖ È°πÁõÆ${editingProjectId ? 'Êõ¥Êñ∞' : 'ÂàõÂª∫'}ÊàêÂäü!`);
      setShowDialog(null);
      setEditingProjectId(null);
      await loadProjectDetails();
    } catch (error) {
      alert('‚ùå ‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
    }
  };

  const handleDeleteProject = async (project) => {
    if (!window.confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§È°πÁõÆ"${project.name}"ÂêóÔºü`)) return;
    
    try {
      await api.deleteProject(project.id);
      alert('‚úÖ È°πÁõÆÂ∑≤Âà†Èô§');
      await loadProjectDetails();
    } catch (error) {
      alert('‚ùå Âà†Èô§Â§±Ë¥•: ' + error.message);
    }
  };

  // ==================== ÊàêÂëòÁõ∏ÂÖ≥Êìç‰Ωú ====================
  const handleAddMember = () => {
    setEditForm({
      id: null,
      name: '',
      role: '',
      department: '',
      phone: '',
      email: '',
      joinDate: '',
      status: 'Âú®ËÅå',
      projectId: selectedProjectFilter || projects[0]?.id
    });
    setShowDialog('addMember');
  };

  const handleEditMember = (member) => {
    setEditForm(member);
    setShowDialog('editMember');
  };

  const handleSaveMember = async () => {
    try {
      const memberData = {
        project_id: editForm.projectId || selectedProjectFilter || projects[0]?.id,
        name: editForm.name,
        role: editForm.role,
        department: editForm.department,
        phone: editForm.phone,
        email: editForm.email,
        join_date: editForm.joinDate,
        status: editForm.status || 'Âú®ËÅå'
      };
      
      await api.saveMember(memberData, editForm.id);
        alert(`‚úÖ ÊàêÂëò${editForm.id ? 'Êõ¥Êñ∞' : 'Ê∑ªÂä†'}ÊàêÂäü!`);
        setShowDialog(null);
        setEditForm({});
      await loadProjectDetails();
    } catch (error) {
      alert('‚ùå Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
    }
  };
  
  const handleDeleteMember = async (id) => {
    if (!window.confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊàêÂëòÂêó?')) return;
    
    try {
      await api.deleteMember(id);
        alert('‚úÖ ÊàêÂëòÂ∑≤Âà†Èô§');
      await loadProjectDetails();
    } catch (error) {
      alert('‚ùå Âà†Èô§Â§±Ë¥•: ' + error.message);
    }
  };

  // ==================== ÊúçÂä°Âô®Áõ∏ÂÖ≥Êìç‰Ωú ====================
  const handleAddServer = () => {
    setEditForm({
      id: null,
      name: '',
      ip: '',
      type: '',
      cpu: '',
      memory: '',
      disk: '',
      status: 'ËøêË°å‰∏≠',
      purpose: '',
      remark: '',
      projectId: selectedProjectFilter || projects[0]?.id
    });
    setShowDialog('addServer');
  };

  const handleEditServer = (server) => {
    setEditForm(server);
    setShowDialog('editServer');
  };

  const handleSaveServer = async () => {
    try {
      const serverData = {
        project_id: editForm.projectId || selectedProjectFilter || projects[0]?.id,
        name: editForm.name,
        ip: editForm.ip,
        type: editForm.type,
        cpu: editForm.cpu,
        memory: editForm.memory,
        disk: editForm.disk,
        status: editForm.status || 'ËøêË°å‰∏≠',
        purpose: editForm.purpose,
        remark: editForm.remark
      };
      
      await api.saveServer(serverData, editForm.id);
        alert(`‚úÖ ÊúçÂä°Âô®${editForm.id ? 'Êõ¥Êñ∞' : 'Ê∑ªÂä†'}ÊàêÂäü!`);
        setShowDialog(null);
        setEditForm({});
      await loadProjectDetails();
    } catch (error) {
      alert('‚ùå Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
    }
  };
  
  const handleDeleteServer = async (id) => {
    if (!window.confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊúçÂä°Âô®Âêó?')) return;
    
    try {
      await api.deleteServer(id);
        alert('‚úÖ ÊúçÂä°Âô®Â∑≤Âà†Èô§');
      await loadProjectDetails();
    } catch (error) {
      alert('‚ùå Âà†Èô§Â§±Ë¥•: ' + error.message);
    }
  };

  // ==================== ËΩØ‰ª∂ËµÑÊñôÁõ∏ÂÖ≥Êìç‰Ωú ====================
  const handleAddResource = () => {
    setEditForm({
      id: null,
      name: '',
      version: '',
      type: '',
      license: '',
      updateDate: '',
      description: '',
      downloadUrl: '',
      projectId: selectedProjectFilter || projects[0]?.id
    });
    setShowDialog('addResource');
  };

  const handleEditResource = (resource) => {
    setEditForm(resource);
    setShowDialog('editResource');
  };

  const handleSaveResource = async () => {
    try {
      const resourceData = {
        project_id: editForm.projectId || selectedProjectFilter || projects[0]?.id,
        name: editForm.name,
        version: editForm.version,
        type: editForm.type,
        license: editForm.license,
        update_date: editForm.updateDate,
        description: editForm.description,
        download_url: editForm.downloadUrl
      };
      
      await api.saveResource(resourceData, editForm.id);
        alert(`‚úÖ ËΩØ‰ª∂ËµÑÊñô${editForm.id ? 'Êõ¥Êñ∞' : 'Ê∑ªÂä†'}ÊàêÂäü!`);
        setShowDialog(null);
        setEditForm({});
      await loadProjectDetails();
    } catch (error) {
      alert('‚ùå Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
    }
  };
  
  const handleDeleteResource = async (id) => {
    if (!window.confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËΩØ‰ª∂ËµÑÊñôÂêó?')) return;
    
    try {
      await api.deleteResource(id);
        alert('‚úÖ ËΩØ‰ª∂ËµÑÊñôÂ∑≤Âà†Èô§');
      await loadProjectDetails();
    } catch (error) {
      alert('‚ùå Âà†Èô§Â§±Ë¥•: ' + error.message);
    }
  };

  // ‰ΩøÁî® useCallback ÂåÖË£ÖË°®ÂçïÂ≠óÊÆµÊõ¥Êñ∞ÂáΩÊï∞
  const updateFormField = useCallback((field, value) => {
    setEditForm(prev => ({ ...prev, [field]: value }));
  }, []);

  // Á≠õÈÄâÊï∞ÊçÆ
  const filteredMembers = getFilteredMembers(members, selectedProjectFilter);
  const filteredServers = getFilteredServers(servers, selectedProjectFilter);
  const filteredResources = getFilteredResources(resources, selectedProjectFilter);

  // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©È°πÁõÆÔºåÊòæÁ§∫ÊèêÁ§∫
  if (!selectedProject) {
    return (
      <div style={{
        padding: isMobile ? '20px' : '40px',
        textAlign: 'center',
        color: '#95a5a6'
      }}>
        <div style={{ fontSize: '48px', marginBottom: '16px' }}>üìã</div>
        <div style={{ fontSize: '18px' }}>ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™È°πÁõÆ</div>
      </div>
    );
  }

  return (
    <div style={{
      padding: isMobile ? '12px' : '24px',
      maxWidth: '1400px',
      margin: '0 auto'
    }}>
      {/* È°∂ÈÉ®Ê†áÈ¢òÂç°Áâá */}
      <div style={{
        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        borderRadius: isMobile ? '12px' : '16px',
        padding: isMobile ? '24px' : '32px',
        marginBottom: '24px',
        color: 'white',
        boxShadow: '0 4px 16px rgba(102, 126, 234, 0.3)'
      }}>
        <div style={{
          display: 'flex',
          alignItems: 'center',
          gap: '16px',
          marginBottom: '16px',
          flexWrap: 'wrap'
        }}>
          <div style={{ fontSize: isMobile ? '32px' : '48px' }}>üéØ</div>
          <div style={{ flex: 1, minWidth: '200px' }}>
            <h2 style={{ margin: '0 0 8px 0', fontSize: isMobile ? '20px' : '28px' }}>
              È°πÁõÆÁÆ°ÁêÜ
            </h2>
            <p style={{ margin: 0, opacity: 0.9, fontSize: isMobile ? '14px' : '16px' }}>
              ÊâÄÊúâÈ°πÁõÆÁöÑÁªºÂêàÁÆ°ÁêÜ‰∏éÁª¥Êä§
            </p>
          </div>
        </div>
      </div>

      {/* TabÂØºËà™ */}
      <div style={{
        background: 'white',
        borderRadius: isMobile ? '12px' : '16px',
        padding: isMobile ? '12px' : '16px',
        marginBottom: '24px',
        boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
        overflowX: 'auto'
      }}>
        <div style={{
          display: 'flex',
          gap: isMobile ? '8px' : '16px',
          minWidth: 'fit-content'
        }}>
          {tabs.map(tab => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              style={{
                flex: isMobile ? '0 0 auto' : 1,
                padding: isMobile ? '12px 16px' : '16px 24px',
                background: activeTab === tab.id 
                  ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                  : 'transparent',
                color: activeTab === tab.id ? 'white' : '#555',
                border: 'none',
                borderRadius: '12px',
                cursor: 'pointer',
                fontSize: isMobile ? '14px' : '16px',
                fontWeight: activeTab === tab.id ? '600' : '500',
                transition: 'all 0.3s ease',
                whiteSpace: 'nowrap'
              }}
            >
              <span style={{ marginRight: '8px' }}>{tab.icon}</span>
              {tab.name}
            </button>
          ))}
        </div>
      </div>

      {/* ÂÜÖÂÆπÂå∫Âüü */}
      <div>
        {activeTab === 'info' && (
          <ProjectInfo
            projects={projects}
            user={user}
            isMobile={isMobile}
            onAddProject={handleAddProject}
            onEditProject={handleEditProject}
            onDeleteProject={handleDeleteProject}
          />
        )}
        {activeTab === 'members' && (
          <MemberManagement
            members={filteredMembers}
            projects={projects}
            selectedProjectFilter={selectedProjectFilter}
            onProjectFilterChange={setSelectedProjectFilter}
            user={user}
            isMobile={isMobile}
            onAddMember={handleAddMember}
            onEditMember={handleEditMember}
            onDeleteMember={handleDeleteMember}
          />
        )}
        {activeTab === 'servers' && (
          <ServerManagement
            servers={filteredServers}
            projects={projects}
            selectedProjectFilter={selectedProjectFilter}
            onProjectFilterChange={setSelectedProjectFilter}
            user={user}
            isMobile={isMobile}
            onAddServer={handleAddServer}
            onEditServer={handleEditServer}
            onDeleteServer={handleDeleteServer}
          />
        )}
        {activeTab === 'resources' && (
          <ResourceManagement
            resources={filteredResources}
            projects={projects}
            selectedProjectFilter={selectedProjectFilter}
            onProjectFilterChange={setSelectedProjectFilter}
            user={user}
            isMobile={isMobile}
            onAddResource={handleAddResource}
            onEditResource={handleEditResource}
            onDeleteResource={handleDeleteResource}
          />
        )}
      </div>

      {/* ÁºñËæëÂØπËØùÊ°Ü */}
      <ProjectEditDialog
        show={showDialog === 'editProject'}
        editForm={editForm}
        editingProjectId={editingProjectId}
        isMobile={isMobile}
        managers={allUsers}
        onClose={() => setShowDialog(null)}
        onSave={handleSaveProject}
        onChange={setEditForm}
      />

      <MemberDialog
        show={showDialog === 'addMember' || showDialog === 'editMember'}
        editForm={editForm}
        projects={projects}
        allUsers={allUsers}
        isMobile={isMobile}
        onClose={() => setShowDialog(null)}
        onSave={handleSaveMember}
        onChange={setEditForm}
      />

      <ServerDialog
        show={showDialog === 'addServer' || showDialog === 'editServer'}
        editForm={editForm}
        projects={projects}
        isMobile={isMobile}
        onClose={() => setShowDialog(null)}
        onSave={handleSaveServer}
        onChange={setEditForm}
      />

      <ResourceDialog
        show={showDialog === 'addResource' || showDialog === 'editResource'}
        editForm={editForm}
        projects={projects}
        isMobile={isMobile}
        onClose={() => setShowDialog(null)}
        onSave={handleSaveResource}
        onChange={setEditForm}
      />

      {/* CSSÂä®Áîª */}
      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes slideUp {
          from {
            opacity: 0;
            transform: translateY(30px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
      `}</style>
    </div>
  );
};

export default ProjectManagementDetail;

