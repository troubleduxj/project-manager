const database = require('./database/db');
const bcrypt = require('bcryptjs');

async function initializeDatabase() {
  try {
    await database.connect();
    
    console.log('üîß ÂºÄÂßãÂàùÂßãÂåñÊï∞ÊçÆÂ∫ì...');

    // ÂàõÂª∫Áî®Êà∑Ë°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username VARCHAR(50) UNIQUE NOT NULL,
        email VARCHAR(100) UNIQUE NOT NULL,
        password VARCHAR(255) NOT NULL,
        role VARCHAR(20) DEFAULT 'client',
        full_name VARCHAR(100),
        avatar VARCHAR(255),
        status VARCHAR(20) DEFAULT 'active',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `);

    // ÂàõÂª∫È°πÁõÆË°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS projects (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name VARCHAR(100) NOT NULL,
        description TEXT,
        status VARCHAR(20) DEFAULT 'planning',
        priority VARCHAR(10) DEFAULT 'medium',
        type VARCHAR(50),
        start_date DATE,
        end_date DATE,
        client_id INTEGER,
        manager_id INTEGER,
        progress INTEGER DEFAULT 0,
        budget DECIMAL(10,2),
        department VARCHAR(50),
        team VARCHAR(100),
        customer VARCHAR(100),
        is_default BOOLEAN DEFAULT 0,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (client_id) REFERENCES users(id),
        FOREIGN KEY (manager_id) REFERENCES users(id)
      )
    `);

    // ÂàõÂª∫È°πÁõÆËøõÂ∫¶Ë°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS project_progress (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        project_id INTEGER NOT NULL,
        task_name VARCHAR(200) NOT NULL,
        description TEXT,
        status VARCHAR(20) DEFAULT 'todo',
        progress INTEGER DEFAULT 0,
        assigned_to INTEGER,
        parent_task_id INTEGER,
        start_date DATE,
        due_date DATE,
        completed_at DATETIME,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (project_id) REFERENCES projects(id),
        FOREIGN KEY (assigned_to) REFERENCES users(id),
        FOREIGN KEY (parent_task_id) REFERENCES project_progress(id)
      )
    `);

    // ÂàõÂª∫ÊñáÊ°£Êñá‰ª∂Â§πË°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS document_folders (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        project_id INTEGER NOT NULL,
        name VARCHAR(255) NOT NULL,
        description TEXT,
        icon VARCHAR(50),
        color VARCHAR(50),
        parent_folder_id INTEGER,
        created_by INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
        FOREIGN KEY (parent_folder_id) REFERENCES document_folders(id) ON DELETE CASCADE,
        FOREIGN KEY (created_by) REFERENCES users(id) ON DELETE SET NULL
      )
    `);

    // ÂàõÂª∫ÊñáÊ°£Ë°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS documents (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        project_id INTEGER NOT NULL,
        title VARCHAR(200) NOT NULL,
        content TEXT,
        file_path VARCHAR(500),
        file_type VARCHAR(50),
        file_size INTEGER,
        version VARCHAR(20) DEFAULT '1.0',
        category VARCHAR(50),
        is_public BOOLEAN DEFAULT 0,
        uploaded_by INTEGER,
        folder_id INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (project_id) REFERENCES projects(id),
        FOREIGN KEY (uploaded_by) REFERENCES users(id),
        FOREIGN KEY (folder_id) REFERENCES document_folders(id) ON DELETE SET NULL
      )
    `);

    // ÂàõÂª∫Ê∂àÊÅØË°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS messages (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        project_id INTEGER,
        sender_id INTEGER NOT NULL,
        receiver_id INTEGER NOT NULL,
        message TEXT NOT NULL,
        message_type VARCHAR(50) DEFAULT 'text',
        title VARCHAR(200),
        attachment_path VARCHAR(500),
        is_read BOOLEAN DEFAULT 0,
        read_at DATETIME,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (project_id) REFERENCES projects(id),
        FOREIGN KEY (sender_id) REFERENCES users(id),
        FOREIGN KEY (receiver_id) REFERENCES users(id)
      )
    `);

    // ÂàõÂª∫Á≥ªÁªüËÆæÁΩÆË°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS settings (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        key VARCHAR(100) UNIQUE NOT NULL,
        value TEXT,
        description TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `);

    // ÂàõÂª∫È°πÁõÆÊàêÂëòË°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS project_members (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        project_id INTEGER NOT NULL,
        user_id INTEGER,
        name VARCHAR(100) NOT NULL,
        role VARCHAR(50),
        department VARCHAR(50),
        phone VARCHAR(20),
        email VARCHAR(100),
        join_date DATE,
        status VARCHAR(20) DEFAULT 'active',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
      )
    `);

    // ÂàõÂª∫È°πÁõÆÊúçÂä°Âô®Ë°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS project_servers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        project_id INTEGER NOT NULL,
        name VARCHAR(100) NOT NULL,
        ip VARCHAR(50),
        type VARCHAR(50),
        cpu VARCHAR(50),
        memory VARCHAR(50),
        disk VARCHAR(50),
        status VARCHAR(20) DEFAULT 'running',
        purpose VARCHAR(200),
        remark TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
      )
    `);

    // ÂàõÂª∫È°πÁõÆËΩØ‰ª∂ËµÑÊñôË°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS project_resources (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        project_id INTEGER NOT NULL,
        name VARCHAR(100) NOT NULL,
        version VARCHAR(50),
        type VARCHAR(50),
        license VARCHAR(100),
        update_date DATE,
        description TEXT,
        download_url VARCHAR(500),
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
      )
    `);

    // ÂàõÂª∫Áî®Êà∑ÈÄöÁü•ËÆæÁΩÆË°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS user_notification_settings (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER NOT NULL,
        email_notifications BOOLEAN DEFAULT 1,
        task_notifications BOOLEAN DEFAULT 1,
        project_notifications BOOLEAN DEFAULT 1,
        document_notifications BOOLEAN DEFAULT 1,
        system_notifications BOOLEAN DEFAULT 1,
        comment_notifications BOOLEAN DEFAULT 1,
        notification_frequency VARCHAR(20) DEFAULT 'immediate',
        quiet_hours_start TIME DEFAULT '22:00',
        quiet_hours_end TIME DEFAULT '08:00',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
      )
    `);

    // ÂàõÂª∫‰ªªÂä°ËØÑËÆ∫Ë°®
    await database.run(`
      CREATE TABLE IF NOT EXISTS task_comments (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        task_id INTEGER NOT NULL,
        user_id INTEGER NOT NULL,
        content TEXT NOT NULL,
        mentioned_users TEXT, -- JSONÊ†ºÂºèÂ≠òÂÇ®@ÁöÑÁî®Êà∑IDÊï∞ÁªÑ
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (task_id) REFERENCES project_progress (id),
        FOREIGN KEY (user_id) REFERENCES users (id)
      )
    `);

    console.log('‚úÖ Êï∞ÊçÆÂ∫ìË°®ÂàõÂª∫ÂÆåÊàê');

    // ÂàõÂª∫ÈªòËÆ§ÁÆ°ÁêÜÂëòÁî®Êà∑
    const adminExists = await database.get('SELECT id FROM users WHERE username = ?', ['admin']);
    
    if (!adminExists) {
      const hashedPassword = await bcrypt.hash('admin123', 10);
      await database.run(`
        INSERT INTO users (username, email, password, role, full_name)
        VALUES (?, ?, ?, ?, ?)
      `, ['admin', 'admin@example.com', hashedPassword, 'admin', 'Á≥ªÁªüÁÆ°ÁêÜÂëò']);
      
      console.log('‚úÖ ÈªòËÆ§ÁÆ°ÁêÜÂëòÁî®Êà∑ÂàõÂª∫ÂÆåÊàê');
      console.log('   Áî®Êà∑Âêç: admin');
      console.log('   ÂØÜÁ†Å: admin123');
    }

    // ÂàõÂª∫Á§∫‰æãÂÆ¢Êà∑Áî®Êà∑
    const clientExists = await database.get('SELECT id FROM users WHERE username = ?', ['client']);
    
    if (!clientExists) {
      const hashedPassword = await bcrypt.hash('client123', 10);
      await database.run(`
        INSERT INTO users (username, email, password, role, full_name)
        VALUES (?, ?, ?, ?, ?)
      `, ['client', 'client@example.com', hashedPassword, 'client', 'Á§∫‰æãÂÆ¢Êà∑']);
      
      console.log('‚úÖ Á§∫‰æãÂÆ¢Êà∑Áî®Êà∑ÂàõÂª∫ÂÆåÊàê');
      console.log('   Áî®Êà∑Âêç: client');
      console.log('   ÂØÜÁ†Å: client123');
    }

    // ÊèíÂÖ•Á≥ªÁªüËÆæÁΩÆ
    const settings = [
      ['site_name', 'È°πÁõÆÁÆ°ÁêÜÁ≥ªÁªü', 'ÁΩëÁ´ôÂêçÁß∞'],
      ['site_description', '‰∏ì‰∏öÁöÑÈ°πÁõÆÁÆ°ÁêÜ‰∏éÊñáÊ°£Êü•ÁúãÁ≥ªÁªü', 'ÁΩëÁ´ôÊèèËø∞'],
      ['max_file_size', '10485760', 'ÊúÄÂ§ßÊñá‰ª∂‰∏ä‰º†Â§ßÂ∞èÔºàÂ≠óËäÇÔºâ'],
      ['allowed_file_types', 'pdf,doc,docx,txt,md,jpg,png,gif', 'ÂÖÅËÆ∏ÁöÑÊñá‰ª∂Á±ªÂûã'],
      // ÈÇÆ‰ª∂ÈÖçÁΩÆ
      ['smtp_host', 'smtp.exmail.qq.com', 'SMTPÊúçÂä°Âô®Âú∞ÂùÄ'],
      ['smtp_port', '465', 'SMTPÁ´ØÂè£'],
      ['smtp_user', 'xj.du@hanatech.com.cn', 'SMTPÁî®Êà∑Âêç'],
      ['smtp_pass', 'Dxj19831010', 'SMTPÂØÜÁ†Å'],
      ['from_name', 'ÊùúÊôìÂÜõ', 'Âèë‰ª∂‰∫∫ÂêçÁß∞'],
      ['from_email', 'xj.du@hanatech.com.cn', 'Âèë‰ª∂‰∫∫ÈÇÆÁÆ±'],
      ['test_email', 'duxiaojun1983@163.com', 'ÊµãËØïÈÇÆÁÆ±'],
      ['enable_ssl', 'true', 'ÂêØÁî®SSL'],
      ['enable_tls', 'false', 'ÂêØÁî®TLS']
    ];

    for (const [key, value, description] of settings) {
      const exists = await database.get('SELECT id FROM settings WHERE key = ?', [key]);
      if (!exists) {
        await database.run(`
          INSERT INTO settings (key, value, description)
          VALUES (?, ?, ?)
        `, [key, value, description]);
      }
    }

    console.log('‚úÖ Á≥ªÁªüËÆæÁΩÆÂàùÂßãÂåñÂÆåÊàê');

    // ÂàõÂª∫Á§∫‰æãÈ°πÁõÆ
    const projectExists = await database.get('SELECT id FROM projects WHERE name = ?', ['Á§∫‰æãÈ°πÁõÆ']);
    
    if (!projectExists) {
      const adminUser = await database.get('SELECT id FROM users WHERE username = ?', ['admin']);
      const clientUser = await database.get('SELECT id FROM users WHERE username = ?', ['client']);
      
      const result = await database.run(`
        INSERT INTO projects (name, description, status, priority, client_id, manager_id, progress, start_date, end_date)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
      `, [
        'Á§∫‰æãÈ°πÁõÆ',
        'ËøôÊòØ‰∏Ä‰∏™Á§∫‰æãÈ°πÁõÆÔºåÁî®‰∫éÊºîÁ§∫Á≥ªÁªüÂäüËÉΩ',
        'in_progress',
        'high',
        clientUser.id,
        adminUser.id,
        35,
        '2025-10-01',
        '2025-12-31'
      ]);

      // ÂàõÂª∫Á§∫‰æã‰ªªÂä°
      const tasks = [
        ['ÈúÄÊ±ÇÂàÜÊûê', 'Êî∂ÈõÜÂíåÂàÜÊûêÈ°πÁõÆÈúÄÊ±Ç', 'completed', 100],
        ['Á≥ªÁªüËÆæËÆ°', 'ËÆæËÆ°Á≥ªÁªüÊû∂ÊûÑÂíåÊï∞ÊçÆÂ∫ì', 'completed', 100],
        ['ÂâçÁ´ØÂºÄÂèë', 'ÂºÄÂèëÁî®Êà∑ÁïåÈù¢', 'in_progress', 60],
        ['ÂêéÁ´ØÂºÄÂèë', 'ÂºÄÂèëAPIÂíå‰∏öÂä°ÈÄªËæë', 'in_progress', 40],
        ['ÊµãËØïÈÉ®ÁΩ≤', 'Á≥ªÁªüÊµãËØïÂíåÈÉ®ÁΩ≤‰∏äÁ∫ø', 'pending', 0]
      ];

      for (const [taskName, description, status, progress] of tasks) {
        await database.run(`
          INSERT INTO project_progress (project_id, task_name, description, status, progress, assigned_to)
          VALUES (?, ?, ?, ?, ?, ?)
        `, [result.id, taskName, description, status, progress, adminUser.id]);
      }

      console.log('‚úÖ Á§∫‰æãÈ°πÁõÆÂíå‰ªªÂä°ÂàõÂª∫ÂÆåÊàê');
    }

    console.log('üéâ Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñÂÆåÊàêÔºÅ');
    console.log('');
    console.log('ÂèØ‰ª•‰ΩøÁî®‰ª•‰∏ãË¥¶Êà∑ÁôªÂΩïÔºö');
    console.log('ÁÆ°ÁêÜÂëò - Áî®Êà∑Âêç: admin, ÂØÜÁ†Å: admin123');
    console.log('ÂÆ¢Êà∑   - Áî®Êà∑Âêç: client, ÂØÜÁ†Å: client123');

  } catch (error) {
    console.error('‚ùå Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñÂ§±Ë¥•:', error);
  } finally {
    await database.close();
  }
}

// Â¶ÇÊûúÁõ¥Êé•ËøêË°åÊ≠§Êñá‰ª∂ÔºåÂàôÊâßË°åÂàùÂßãÂåñ
if (require.main === module) {
  initializeDatabase();
}

module.exports = initializeDatabase;
